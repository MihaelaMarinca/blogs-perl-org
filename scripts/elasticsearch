#!/usr/bin/env perl

use strict;
use warnings;

use DBI;
use Search::Elasticsearch;
use Try::Tiny;

$|++;

my $in_dsn = 'dbi:mysql:database=BlogsPerlOrg';
my $e = Search::Elasticsearch->new;

my $in_dbh = DBI->connect($in_dsn,'root');

###############################################################################

sub index_posts {
  my $in_sth = $in_dbh->prepare(<<'EOF');
  SELECT u.username, p.id, p.slug, p.title, p.content, p.created_date
    FROM post p
    JOIN `user` u ON p.user_id = u.id
ORDER BY p.id
EOF

#  my $out_sth = $out_dbh->prepare(
#    'INSERT INTO post(id,title,slug,description,content,created_date,status,user_id) VALUES(?,?,?,?,?,?,?,?)'
#  );
  $in_sth->execute();

  my $count  = 0;
  while ( my $post = $in_sth->fetchrow_hashref ) {
    print '.' if $count++ % 100 == 0;
#use Data::Dumper; print Dumper($in_post);
#last;
    $e->index(
      index   => 'posts',
      type    => 'published_blog_posts',
      id      => $post->{id},
      body    => {
          id      => $post->{id},
          slug    => $post->{slug},
          title   => $post->{title},
          content => $post->{content},
          date    => $post->{created_date}
      }
    );
  }
}

sub index_comments {
  my $in_sth = $in_dbh->prepare(<<'EOF');
  SELECT u.username, p.slug, c.id, c.email, c.content, c.comment_date
    FROM comment c
    JOIN `user` u ON c.uid = u.id
    JOIN post p ON c.post_id = p.id
ORDER BY c.id
EOF
  $in_sth->execute();

  my $count  = 0;
  while ( my $comment = $in_sth->fetchrow_hashref ) {
    print '.' if $count++ % 100 == 0;
#use Data::Dumper; print Dumper($in_comment);
#last;
    $e->index(
      index   => 'comments',
      type    => 'published_comments',
      id      => $comment->{id},
      body    => {
          id        => $comment->{id},
          post_slug => $comment->{slug},
          username  => $comment->{username},
          email     => $comment->{email},
          content   => $comment->{content},
          date      => $comment->{comment_date},
          status    => $comment->{status}
      }
    );
  }
}

###############################################################################

print "indexing posts: ";
index_posts;
print "\n";

print "indexing comments: ";
index_comments;
print "\n";
